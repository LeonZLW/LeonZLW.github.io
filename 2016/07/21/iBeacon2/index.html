<!DOCTYPE HTML>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  
  <title>iBeacon调研实践(二) | Leon’s Blog | Dreams don&#39;t work unless you do.</title>

  
  <meta name="author" content="Leon">
  

  
  <meta name="description" content="iOS Developer">
  

  
  
  <meta name="keywords" content="iOS">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="iBeacon调研实践(二)">

  <meta property="og:site_name" content="Leon’s Blog">

  
  <meta property="og:image" content="/favicon.ico">
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="Leon’s Blog" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
</head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">Leon’s Blog</a>
    </h1>
    <p class="site-description">Dreams don&#39;t work unless you do.</p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">主页</a></li>
      
        <li><a href="/archives">归档</a></li>
      
        <li><a href="/categories">分类</a></li>
      
        <li><a href="/tags">标签</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>iBeacon调研实践(二)</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2016/07/21/iBeacon2/" rel="bookmark">
        <time class="entry-date published" datetime="2016-07-21T06:26:36.000Z">
          2016-07-21
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p><a href="http://leonzlw.github.io/2017/02/14/iBeacon/" target="_blank" rel="noopener">iBeacon调研记录(一)</a>主要介绍了iBeacon(Bluetooth Low Energy)是什么,使用场景,API介绍及注意事项。如果看过了上篇文章,相信你对iBeacon已经有了初步了解,这篇文章主要是利用上一篇所记录的内容写一个方便监视iBeacon设备信号动态变化和修改监视区域参数的工具。</p>
<p>简单描述一下需求:</p>
<ul>
<li>实时监测到iBeacon信号变化</li>
<li>可以方便添加/删除/修改监视的iBeacon</li>
<li>从边界进入到监视区域会通知用户 (在前台:弹出提示框  在后台:本地推送消息)</li>
<li>刚开始就在监视区域通知用户 (在前台:弹出提示框  在后台:本地推送消息)</li>
<li>同一区域不重复性提示用户</li>
</ul>
<p>看了上面的需求,首先我们要有一个列表用来展示所有iBeacon信号变化,当进行添加/修改操作的时候,需要跳转到一个新的页面去编辑,编辑完成之后再跳回到iBeacon列表页面,页面的简单操作描述就是这样。</p>
<p>最终在真机下的效果:<img src="http://7xob19.com1.z0.glb.clouddn.com/iBeacon2.gif" alt></p>
<a id="more"></a>
<p>在开撸之前,还要了解一下<code>CLBeaconRegion</code>和<code>CLBeacon</code>:  </p>
<ul>
<li><strong>CLBeaconRegion:</strong>用来设置监视区域的行为特征(比如:设置notifyEntryStateOnDisplay=YES),还有存放监视区域的UUID,Major,Minor等信息。</li>
<li><strong>CLBeacon:</strong>相当于我们的iBeacon设备信息,我们不仅可以从中获取到UUID,Major,Minor,还能获取到accuracy(距离),RSSI(信号强度)等信息。</li>
</ul>
<p>开撸!</p>
<p>首先我们要在新建工程的info.plist文件中添加<code>Privacy - Location When In Use Usage Description</code> 或 <code>Privacy - Location Always Usage Description</code>来告诉系统我们要使用定位服务,苹果把iBeacon集成到了<code>&lt;CoreLocation/CoreLocation.h&gt;</code>框架中,由<code>CLLocationManager</code>来管理。  </p>
<p>在iBeacon列表控制器,声明这三个属性:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">@interface IBMBeaconViewController ()&lt;CLLocationManagerDelegate, UITableViewDelegate, UITableViewDataSource&gt;</span><br><span class="line"></span><br><span class="line">// 定位管理</span><br><span class="line">@property (nonatomic, strong) CLLocationManager *locationManager;</span><br><span class="line">// 存放IBMBeaconItem的数组</span><br><span class="line">@property (nonatomic, strong) NSMutableArray *beaconItems;</span><br><span class="line">// tableView视图</span><br><span class="line">@property (weak, nonatomic) IBOutlet UITableView *beaconTableView;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">// 在实现中利用懒加载初始化,beaconTableView是在storyboard的控件,无需代码初始化</span><br><span class="line">@implementation IBMBeaconViewController</span><br><span class="line"></span><br><span class="line">- (CLLocationManager *)locationManager &#123;</span><br><span class="line">    if (!_locationManager) &#123;</span><br><span class="line">        _locationManager = [[CLLocationManager alloc]init];</span><br><span class="line">        _locationManager.delegate = self;</span><br><span class="line">        // iOS8后要手动授权</span><br><span class="line">        [_locationManager requestWhenInUseAuthorization];</span><br><span class="line">    &#125;</span><br><span class="line">    return _locationManager;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (NSMutableArray *)beaconItems &#123;</span><br><span class="line">    if (!_beaconItems) &#123;</span><br><span class="line">        _beaconItems = [NSMutableArray array];</span><br><span class="line">    &#125;</span><br><span class="line">    return _beaconItems;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>beaconItems中存放的是IBMBeaconItem类的实例,IBMBeaconItem用来存放iBeacon的信息:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line">#import &lt;CoreLocation/CoreLocation.h&gt;</span><br><span class="line"></span><br><span class="line">@interface IBMBeaconItem : NSObject&lt;NSCoding&gt;</span><br><span class="line"></span><br><span class="line">// 设备的名字(identifier)</span><br><span class="line">@property (strong, nonatomic, readonly) NSString *name;</span><br><span class="line">@property (strong, nonatomic, readonly) NSUUID *uuid;</span><br><span class="line">@property (assign, nonatomic, readonly) CLBeaconMajorValue majorValue;</span><br><span class="line">@property (assign, nonatomic, readonly) CLBeaconMinorValue minorValue;</span><br><span class="line">// 记录每次通知的时间</span><br><span class="line">@property (nonatomic, strong) NSDate *lastNotifyDate;</span><br><span class="line">// 匹配的CLBeacon</span><br><span class="line">@property (nonatomic, strong) CLBeacon *beaconMatching;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (instancetype)initWithName:(NSString *)name</span><br><span class="line">                        uuid:(NSUUID *)uuid</span><br><span class="line">                       major:(CLBeaconMajorValue)major</span><br><span class="line">                       minor:(CLBeaconMinorValue)minor;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> 判断IBMBeaconItem实例的信息是否与检测到的区域相同</span><br><span class="line"></span><br><span class="line"> @param beaconRegion CLBeaconRegion区域实例</span><br><span class="line"> @return 判断结果</span><br><span class="line"> */</span><br><span class="line">- (BOOL)isEqualToCLBeaconRegion:(CLBeaconRegion *)beaconRegion;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> 判断是否需要发送通知(当前时间 - 上次通知记录的时间(lastNotifyDate) &gt; 规定的时间  就返回YES发送通知 否则NO)</span><br><span class="line"></span><br><span class="line"> @return 判断结果</span><br><span class="line"> */</span><br><span class="line">- (BOOL)shouldSendNotificaiton;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> 判断IBMBeaconItem实例的信息是否与检测到的设备信息相同</span><br><span class="line"></span><br><span class="line"> @param beacon 设备实例</span><br><span class="line"> @return 判断结果</span><br><span class="line"> */</span><br><span class="line">- (BOOL)isEqualToCLBeacon:(CLBeacon *)beacon;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">// 下面是实现类.m</span><br><span class="line">#import &quot;IBMBeaconItem.h&quot;</span><br><span class="line"></span><br><span class="line">static NSString *const ibeaconName = @&quot;ibeaconName&quot;;</span><br><span class="line">static NSString *const iBeaconUUID = @&quot;iBeaconUUID&quot;;</span><br><span class="line">static NSString *const iBeaconMajor = @&quot;iBeaconMajor&quot;;</span><br><span class="line">static NSString *const iBeaconMinor = @&quot;iBeaconMinor&quot;;</span><br><span class="line">static NSString *const iBeaconLastNotifyDate = @&quot;iBeaconLastNotifyDate&quot;;</span><br><span class="line"></span><br><span class="line">// 过期时间间隔,默认是10.0s (当前时间 - 上次发送通知时间 &gt; expiredTime 就发送通知)</span><br><span class="line">static const NSTimeInterval expiredTime = 10.0;</span><br><span class="line"></span><br><span class="line">@implementation IBMBeaconItem</span><br><span class="line"></span><br><span class="line">- (instancetype)initWithName:(NSString *)name</span><br><span class="line">                        uuid:(NSUUID *)uuid</span><br><span class="line">                       major:(CLBeaconMajorValue)major</span><br><span class="line">                       minor:(CLBeaconMinorValue)minor</span><br><span class="line">&#123;</span><br><span class="line">    self = [super init];</span><br><span class="line">    </span><br><span class="line">    if (self) &#123;</span><br><span class="line">        _name = name;</span><br><span class="line">        _uuid = uuid;</span><br><span class="line">        _majorValue = major;</span><br><span class="line">        _minorValue = minor;</span><br><span class="line">    &#125;</span><br><span class="line">    return self;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (instancetype)initWithCoder:(NSCoder *)aDecoder &#123;</span><br><span class="line">    self = [super init];</span><br><span class="line">    if (self) &#123;</span><br><span class="line">        </span><br><span class="line">        _name = [aDecoder decodeObjectForKey:ibeaconName];</span><br><span class="line">        _uuid = [aDecoder decodeObjectForKey:iBeaconUUID];</span><br><span class="line">        _majorValue = [[aDecoder decodeObjectForKey:iBeaconMajor] unsignedIntegerValue];</span><br><span class="line">        _minorValue = [[aDecoder decodeObjectForKey:iBeaconMinor] unsignedIntegerValue];</span><br><span class="line">        _lastNotifyDate = [aDecoder decodeObjectForKey:iBeaconLastNotifyDate];</span><br><span class="line">    &#125;</span><br><span class="line">    return self;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)encodeWithCoder:(NSCoder *)aCoder &#123;</span><br><span class="line">    </span><br><span class="line">    [aCoder encodeObject:self.name forKey:ibeaconName];</span><br><span class="line">    [aCoder encodeObject:self.uuid forKey:iBeaconUUID];</span><br><span class="line">    [aCoder encodeObject:@(self.majorValue) forKey:iBeaconMajor];</span><br><span class="line">    [aCoder encodeObject:@(self.minorValue) forKey:iBeaconMinor];</span><br><span class="line">    [aCoder encodeObject:self.lastNotifyDate forKey:iBeaconLastNotifyDate];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (BOOL)isEqualToCLBeaconRegion:(CLBeaconRegion *)beaconRegion &#123;</span><br><span class="line">    </span><br><span class="line">    return [self isEqualToBeaconInfo:beaconRegion];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (BOOL)isEqualToBeaconInfo:(id)beaconInfo &#123;</span><br><span class="line">    if ([[[beaconInfo valueForKey:@&quot;proximityUUID&quot;] UUIDString] isEqualToString:[self.uuid UUIDString]] &amp;&amp;</span><br><span class="line">        [[beaconInfo valueForKey:@&quot;major&quot;] isEqual: @(self.majorValue)] &amp;&amp;</span><br><span class="line">        [[beaconInfo valueForKey:@&quot;minor&quot;] isEqual: @(self.minorValue)])</span><br><span class="line">    &#123;</span><br><span class="line">        return YES;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        return NO;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (BOOL)isEqualToCLBeacon:(CLBeacon *)beacon &#123;</span><br><span class="line">    </span><br><span class="line">    return [self isEqualToBeaconInfo:beacon];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (BOOL)shouldSendNotificaiton &#123;</span><br><span class="line">    </span><br><span class="line">    if (self.lastNotifyDate == nil) &#123;</span><br><span class="line">        </span><br><span class="line">        [self updateLastNotifyDate];</span><br><span class="line">        return YES;</span><br><span class="line">    &#125;else &#123;</span><br><span class="line">        </span><br><span class="line">        NSTimeInterval timeInterval = [[NSDate date] timeIntervalSinceDate:self.lastNotifyDate];</span><br><span class="line">        BOOL isNeedUpdate = timeInterval &gt; expiredTime ? YES : NO;</span><br><span class="line">        </span><br><span class="line">        if (isNeedUpdate) &#123;</span><br><span class="line">            </span><br><span class="line">            [self updateLastNotifyDate];</span><br><span class="line">            return YES;</span><br><span class="line">        &#125;else &#123;</span><br><span class="line">            </span><br><span class="line">            return NO;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)setLastNotifyDate:(NSDate *)lastNotifyDate &#123;</span><br><span class="line">    if (lastNotifyDate) &#123;</span><br><span class="line">        _lastNotifyDate = lastNotifyDate;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)updateLastNotifyDate &#123;</span><br><span class="line">    self.lastNotifyDate = [[NSDate alloc] initWithTimeIntervalSinceNow:0];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (NSString *)description &#123;</span><br><span class="line">    NSString *descriptionStr = [NSString stringWithFormat:@&quot;name=%@\n uuid=%@ \n majorValue=%d minorValue=%d \n lastNotifyDate=%@&quot;, _name,_uuid,_majorValue,_minorValue, _lastNotifyDate];</span><br><span class="line">    return descriptionStr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>我们不希望每次添加完iBeacon监视区域重新启动程序后添加的数据就没了,所以要做本地持久化处理,而且要在工程的任何地方都要能够访问到(如:Appdelegate中),所以创建了一个用单例初始化的类IBMBeaconItemManager来管理:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#import &quot;IBMBeaconItem.h&quot;</span><br><span class="line"></span><br><span class="line">typedef void(^TraverseBeaconItemHandle)(IBMBeaconItem *item);</span><br><span class="line"></span><br><span class="line">@interface IBMBeaconItemManager : NSObject</span><br><span class="line"></span><br><span class="line">// 存放IBMBeaconItem对象转化成Data类型后的数组</span><br><span class="line">@property (nonatomic, copy, readonly) NSArray&lt;NSData *&gt; *storeItemsData;</span><br><span class="line">// 存放IBMBeaconItem对象的数组</span><br><span class="line">@property (nonatomic, copy, readonly) NSArray&lt;IBMBeaconItem *&gt; *storeItems;</span><br><span class="line"></span><br><span class="line">+ (instancetype)sharedInstanced;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> 同步本地数据,比如在客户端我们在做添加/删除/修改 操作的时候,要与本地的数据同步一下</span><br><span class="line"></span><br><span class="line"> @param latestItems 要同步的数组&lt;IBMBeaconItem *&gt;</span><br><span class="line"> */</span><br><span class="line">- (void)syncStoreItemsWithLatestItems:(NSArray&lt;IBMBeaconItem *&gt; *)latestItems;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> 遍历本地存放的ItemData,把Data转化成IBMBeaconItem并每一次遍历都会把IBMBeaconItem通过TraverseBeaconItemHandle传到调用的地方,详情请看实现代码</span><br><span class="line"></span><br><span class="line"> @param itemHandle Block</span><br><span class="line"> */</span><br><span class="line">- (void)TraverseStoreItemsHandle:(TraverseBeaconItemHandle)itemHandle;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// IBMBeaconItemManager.m实现代码</span><br><span class="line">#import &quot;IBMBeaconItemManager.h&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// 本地存储Key值</span><br><span class="line">static NSString *const beaconItemsStoreKey = @&quot;beaconItemsStoreKey&quot;;</span><br><span class="line"></span><br><span class="line">@implementation IBMBeaconItemManager</span><br><span class="line">@synthesize storeItemsData = _storeItemsData;</span><br><span class="line">@synthesize storeItems = _storeItems;</span><br><span class="line"></span><br><span class="line">+ (instancetype)sharedInstanced &#123;</span><br><span class="line">    static IBMBeaconItemManager *manager;</span><br><span class="line">    static dispatch_once_t onceToken;</span><br><span class="line">    dispatch_once(&amp;onceToken, ^&#123;</span><br><span class="line">        manager = [[self alloc]init];</span><br><span class="line">    &#125;);</span><br><span class="line">    return manager;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)TraverseStoreItemsHandle:(TraverseBeaconItemHandle)itemHandle &#123;</span><br><span class="line">    if (self.storeItemsData) &#123;</span><br><span class="line">        for (NSData *itemData in _storeItemsData) &#123;</span><br><span class="line">            IBMBeaconItem *ibeaconItem = [NSKeyedUnarchiver unarchiveObjectWithData:itemData];</span><br><span class="line">            itemHandle(ibeaconItem);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)syncStoreItemsWithLatestItems:(NSArray&lt;IBMBeaconItem *&gt; *)latestItems &#123;</span><br><span class="line">    NSMutableArray *cacheItemsData = [NSMutableArray array];</span><br><span class="line">    for (IBMBeaconItem *item in latestItems) &#123;</span><br><span class="line">        NSData *itemData = [NSKeyedArchiver archivedDataWithRootObject:item];</span><br><span class="line">        [cacheItemsData addObject:itemData];</span><br><span class="line">    &#125;</span><br><span class="line">    _storeItemsData = [cacheItemsData copy];</span><br><span class="line">    _storeItems     = [latestItems copy];</span><br><span class="line">    [[NSUserDefaults standardUserDefaults] setObject:_storeItemsData forKey:beaconItemsStoreKey];</span><br><span class="line">    [[NSUserDefaults standardUserDefaults] synchronize];</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (NSArray&lt;NSData *&gt; *)storeItemsData &#123;</span><br><span class="line">    </span><br><span class="line">    if (!_storeItemsData) &#123;</span><br><span class="line">        </span><br><span class="line">        _storeItemsData = [[NSUserDefaults standardUserDefaults] objectForKey:beaconItemsStoreKey];</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    return _storeItemsData;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (NSArray&lt;IBMBeaconItem *&gt; *)storeItems &#123;</span><br><span class="line">    </span><br><span class="line">    if (!_storeItems) &#123;</span><br><span class="line">        NSMutableArray *mutableStoreItems = [NSMutableArray array];</span><br><span class="line">        if (self.storeItemsData) &#123;</span><br><span class="line">            for (NSData *itemData in _storeItemsData) &#123;</span><br><span class="line">                IBMBeaconItem *ibeaconItem = [NSKeyedUnarchiver unarchiveObjectWithData:itemData];</span><br><span class="line">                [mutableStoreItems addObject:ibeaconItem];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        _storeItems = [mutableStoreItems copy];</span><br><span class="line">    &#125;</span><br><span class="line">    return _storeItems;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>有了IBMBeaconItem和IBMBeaconItemManager后,进入iBeacon列表控制器,在viewDidload中调用loadIbeaconItem方法:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#pragma mark - 步骤1</span><br><span class="line">- (void)loadIbeaconItem &#123;</span><br><span class="line">    // 读取本地数据</span><br><span class="line">    [[IBMBeaconItemManager sharedInstanced] TraverseStoreItemsHandle:^(IBMBeaconItem *item) &#123;</span><br><span class="line">        // 每取到一个IBMBeaconItem 开始对它进行监听</span><br><span class="line">        [self startMonitoringWithItem:item];</span><br><span class="line">        // 添加到tableView的资源数组</span><br><span class="line">        [self.beaconItems addObject:item];</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#pragma mark - 步骤2</span><br><span class="line">- (void)startMonitoringWithItem:(IBMBeaconItem *)ibeaconItem &#123;</span><br><span class="line">    </span><br><span class="line">    CLBeaconRegion *beaconRegion = [self generateBeaconRegionWithItem:ibeaconItem];</span><br><span class="line">    [self.locationManager startMonitoringForRegion:beaconRegion];</span><br><span class="line">    [self.locationManager startRangingBeaconsInRegion:beaconRegion];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#pragma mark - 步骤3</span><br><span class="line">- (CLBeaconRegion *)generateBeaconRegionWithItem:(IBMBeaconItem *)ibeaconItem &#123;</span><br><span class="line">    // 生成iBeacon区域实例,表示我们要监视的区域</span><br><span class="line">    CLBeaconRegion *beaconRegion = [[CLBeaconRegion alloc]initWithProximityUUID:ibeaconItem.uuid</span><br><span class="line">                                                         major:ibeaconItem.majorValue</span><br><span class="line">                                                         minor:ibeaconItem.minorValue</span><br><span class="line">                                                    identifier:ibeaconItem.name];</span><br><span class="line">    // 从黑屏-&gt;亮屏 通知- (void)locationManager:didDetermineState:forRegion:代理方法</span><br><span class="line">    beaconRegion.notifyEntryStateOnDisplay = YES;</span><br><span class="line">    return beaconRegion;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样,我们就开始对iBeacon区域开启了监视,剩下的就是我们要在Appdelegate类中去实现<code>locationManager:didEnterRegion:</code>,<code>locationManager:didExitRegion:</code>,<code>locationManager:didDetermineState:forRegion:</code>代理方法,为什么要写在Appdelegate类中,请看<a href="http://leonzlw.github.io/2017/02/14/iBeacon/" target="_blank" rel="noopener">上篇文章</a>,这里要注意一下:当我将window的rootViewController设置为iBeacon列表控制器,并把所有代理方法实现都写到iBeacon列表控制器中,关闭程序后,依然会调用到代理方法,如果iBeacon列表控制器不设置为window的rootViewController就无法调用到了。所以我们把剩下监测到iBeacon通知的逻辑写到Appdelegate类中:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line">@interface AppDelegate ()&lt;CLLocationManagerDelegate, UIApplicationDelegate&gt;</span><br><span class="line">@property (nonatomic, strong) CLLocationManager *locationManager;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation AppDelegate</span><br><span class="line"></span><br><span class="line">- (BOOL)application:(UIApplication *)application</span><br><span class="line">didFinishLaunchingWithOptions:(NSDictionary *)launchOptions &#123;</span><br><span class="line">    </span><br><span class="line">    self.locationManager.delegate = self;</span><br><span class="line">    </span><br><span class="line">    return YES;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#pragma mark - 本地通知接收</span><br><span class="line">- (void)application:(UIApplication *)application</span><br><span class="line">didReceiveLocalNotification:(UILocalNotification *)notification &#123;</span><br><span class="line">    [self alertMessage:notification.alertBody];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#pragma mark - CLLocationManagerDelegate</span><br><span class="line">// 进入到iBeacon区域(会有延迟,大概30s)</span><br><span class="line">- (void)locationManager:(CLLocationManager *)manager</span><br><span class="line">         didEnterRegion:(CLRegion *)region &#123;</span><br><span class="line">    </span><br><span class="line">    if ([region isKindOfClass:[CLBeaconRegion class]]) &#123;</span><br><span class="line">        CLBeaconRegion *beaconRegion = (CLBeaconRegion *)region;</span><br><span class="line">        [self matchIbeaconRegion:beaconRegion];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)locationManager:(CLLocationManager *)manager</span><br><span class="line">          didExitRegion:(CLRegion *)region &#123;</span><br><span class="line">    NSLog(@&quot;离开iBeacon区域&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// requestStateForRegion:方法调用就会触发该代理方法,另外从黑屏到亮屏过程也会触发</span><br><span class="line">- (void)locationManager:(CLLocationManager *)manager</span><br><span class="line">      didDetermineState:(CLRegionState)state</span><br><span class="line">              forRegion:(CLRegion *)region &#123;</span><br><span class="line">    </span><br><span class="line">    switch (state) &#123;</span><br><span class="line">        case CLRegionStateUnknown:</span><br><span class="line">        &#123;</span><br><span class="line">            NSLog(@&quot;未知&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">            break;</span><br><span class="line">        case CLRegionStateInside:</span><br><span class="line">        &#123;</span><br><span class="line">            NSLog(@&quot;在iBeacon区域里面&quot;);</span><br><span class="line">            if ([region isKindOfClass:[CLBeaconRegion class]]) &#123;</span><br><span class="line">                CLBeaconRegion *beaconRegion = (CLBeaconRegion *)region;</span><br><span class="line">                [self matchIbeaconRegion:beaconRegion];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">            break;</span><br><span class="line">        case CLRegionStateOutside:</span><br><span class="line">        &#123;</span><br><span class="line">            NSLog(@&quot;在iBeacon区域外面&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">            break;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// CLBeaconRegion 来匹配与之对应的 IBMBeaconItem</span><br><span class="line">- (void)matchIbeaconRegion:(CLBeaconRegion *)ibeaconRegion &#123;</span><br><span class="line">    </span><br><span class="line">    NSArray&lt;IBMBeaconItem *&gt; * beaconItems = [IBMBeaconItemManager sharedInstanced].storeItems;</span><br><span class="line">    for (IBMBeaconItem *item in beaconItems) &#123;</span><br><span class="line">        if ([item isEqualToCLBeaconRegion:ibeaconRegion]) &#123;</span><br><span class="line">            [self sendLocalNotificationWithIbeaconItem:item];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 弹出提示框</span><br><span class="line">- (void)alertMessage:(NSString *)message &#123;</span><br><span class="line">    UIAlertView *alertView = [[UIAlertView alloc]initWithTitle:@&quot;提示&quot; message:message delegate:nil cancelButtonTitle:@&quot;确定&quot; otherButtonTitles:nil];</span><br><span class="line">    [alertView show];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 发送本地通知(弹出框)</span><br><span class="line">- (void)sendLocalNotificationWithIbeaconItem:(IBMBeaconItem *)ibeaconItem &#123;</span><br><span class="line">    </span><br><span class="line">    if ([ibeaconItem shouldSendNotificaiton]) &#123;</span><br><span class="line">        </span><br><span class="line">        NSString *notifyString = [NSString stringWithFormat:@&quot;进入%@的iBeacon区域&quot;,ibeaconItem.name];</span><br><span class="line">        UIApplicationState appState = [UIApplication sharedApplication].applicationState;</span><br><span class="line">        switch (appState) &#123;</span><br><span class="line">            case UIApplicationStateActive: // 在前台</span><br><span class="line">            &#123;</span><br><span class="line">                [self alertMessage:notifyString];</span><br><span class="line">                </span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            case UIApplicationStateBackground: // 在后台</span><br><span class="line">            &#123;</span><br><span class="line">                // 通知的代码</span><br><span class="line">                UILocalNotification *notice = [[UILocalNotification alloc] init];</span><br><span class="line">                notice.alertBody = notifyString;</span><br><span class="line">                //        notice.alertAction = @&quot;iBeacon区域提醒&quot;;</span><br><span class="line">                [[UIApplication sharedApplication] scheduleLocalNotification:notice];</span><br><span class="line">                </span><br><span class="line">                UIUserNotificationSettings *settings = [UIUserNotificationSettings settingsForTypes:UIUserNotificationTypeBadge | UIUserNotificationTypeSound | UIUserNotificationTypeAlert categories:nil];</span><br><span class="line">                [[UIApplication sharedApplication] registerUserNotificationSettings:settings];</span><br><span class="line">                break;</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line">             default:</span><br><span class="line">                break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (CLLocationManager *)locationManager &#123;</span><br><span class="line">    if (!_locationManager) &#123;</span><br><span class="line">        _locationManager = [[CLLocationManager alloc]init];</span><br><span class="line">    &#125;</span><br><span class="line">    return _locationManager;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>核心的监测代码就完成啦,剩下的展示内容,新增/修改/删除操作具体实现过程可参考<a href="https://github.com/LeonZLW/IBeaconMonitor" target="_blank" rel="noopener">Demo</a>！</p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/iOS/">iOS</a>
    </span>
    

    </div>

    
  </div>
</article>

  









    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2023 Leon
    
  </p>
</footer>
    
    
  </div>
</div>
</body>
</html>